<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

let ground = canvas.height - 140;
let running = false;
let finished = false;

let score = 0;
let speed = 2; // slow start
let frame = 0;

const heroImg = new Image();
heroImg.src = "mirza.png";

const villainImg = new Image();
villainImg.src = "nasir.png";

let player = {
  x: 80,
  y: ground,
  w: 60,
  h: 80,
  vy: 0,
  jumping: false,
  low: false,
  runTick: 0
};

// villain fixed position
let villain = {
  x: canvas.width - 120,
  y: ground - 120,
  w: 80,
  h: 100
};

let balls = [];
const gravity = 1;

/* ---------- GAME CONTROL ---------- */
function startGame() {
  running = true;
  finished = false;
  score = 0;
  speed = 2;
  frame = 0;
  balls = [];
  player.y = ground;
  player.vy = 0;
  document.getElementById("score").innerText = "Score: 0";
}

/* ---------- INPUT ---------- */
function jump() {
  if (!running) return;
  if (!player.jumping && !player.low) {
    player.vy = -18;
    player.jumping = true;
    navigator.vibrate?.(30);
  }
}

function low() {
  if (!running) return;
  if (!player.jumping) {
    player.low = true;
    player.h = 45;
  }
}

function stand() {
  player.low = false;
  player.h = 80;
}

document.addEventListener("click", jump);
document.addEventListener("keydown", e => {
  if (e.code === "Space") jump();
  if (e.code === "ArrowDown") low();
});
document.addEventListener("keyup", e => {
  if (e.code === "ArrowDown") stand();
});

/* ---------- PROJECTILE ---------- */
function throwBall() {
  balls.push({
    x: villain.x,
    y: villain.y + 30,
    r: 12,
    vx: -speed - 2
  });
}

/* ---------- GAME LOOP ---------- */
function loop() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // villain draw (fixed)
  ctx.drawImage(villainImg, villain.x, villain.y, villain.w, villain.h);

  if (running && !finished) {

    // slow â†’ fast progression
    if (frame % 300 === 0 && speed < 8) {
      speed += 0.5;
    }

    // hero physics
    player.vy += gravity;
    player.y += player.vy;

    if (player.y >= ground) {
      player.y = ground;
      player.vy = 0;
      player.jumping = false;
    }

    // fake running animation
    player.runTick++;
    let runOffset = Math.sin(player.runTick * 0.3) * 4;

    // throw balls
    if (frame % 120 === 0) throwBall();

    balls.forEach(b => {
      b.x += b.vx;

      // collision
      if (
        player.x < b.x + b.r &&
        player.x + player.w > b.x - b.r &&
        player.y < b.y + b.r &&
        player.y + player.h > b.y - b.r
      ) {
        navigator.vibrate?.([100,50,100]);
        finished = true;
      }

      ctx.beginPath();
      ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
      ctx.fillStyle = "#ff4757";
      ctx.fill();
    });

    balls = balls.filter(b => b.x > -20);

    score++;
    document.getElementById("score").innerText = "Score: " + score;
    frame++;
  }

  // hero draw (animated)
  ctx.drawImage(
    heroImg,
    player.x,
    player.y + (player.jumping ? 0 : Math.sin(player.runTick*0.3)*4),
    player.w,
    player.h
  );

  // FINISH text
  if (finished) {
    ctx.fillStyle = "white";
    ctx.font = "bold 48px Arial";
    ctx.textAlign = "center";
    ctx.fillText("FINISH", canvas.width/2, canvas.height/2);
  }

  requestAnimationFrame(loop);
}

loop();
</script>
